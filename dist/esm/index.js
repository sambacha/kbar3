import O from"@reach/portal";import*as o from"react";import{deepEqual as D}from"fast-equals";import{useVirtual as K}from"react-virtual";import{matchSorter as k}from"match-sorter";var m;(function(t){t.animatingIn="animating-in",t.showing="showing",t.animatingOut="animating-out",t.hidden="hidden"})(m||(m={}));class E{constructor(e,n={}){this.children=[],this.id=e.id,this.name=e.name,this.shortcut=e.shortcut,this.keywords=e.keywords,this.perform=e.perform,this.section=e.section,this.icon=e.icon,this.subtitle=e.subtitle,this.parent=n.parent,n.parent&&n.parent.addChild(this),this.parent?.section&&!this.section&&(this.section=this.parent.section)}addChild(e){this.children.find(n=>n===e)||(!e.section&&this.section&&(e.section=this.section),this.children.push(e))}removeChild(e){const n=this.children.findIndex(r=>r===e);n!==-1&&(this.children=[...this.children.slice(0,n),...this.children.slice(n+1)])}static fromJSON(e,n={}){return new E(e,n)}}class T{constructor(e=[]){this.actions={},this.actions=this.add(e)}add(e){const n=e.reduce((r,i)=>(r[i.id]=i,r),{});return e.forEach(r=>{if(this.actions[r.id])return;let i=[r],d=r.parent;for(;d;)this.actions[d]||i.push(n[d]),d=n[d]?.parent;for(;i.length;){const c=i.pop();if(!c)return;const l=c.parent?this.actions[c.parent]:void 0;this.actions[c.id]=E.fromJSON(c,{parent:l}),l&&l.addChild(this.actions[c.id])}}),{...this.actions}}remove(e){return e.forEach(n=>{const r=this.actions[n.id];if(!r)return;let i=r.children;for(;i.length;){const d=i.pop();delete this.actions[d.id],d.children&&i.push(...d.children)}r.parent&&r.parent.removeChild(r),delete this.actions[r.id]}),{...this.actions}}}function L(t){if(!t.actions)throw new Error("You must define a list of `actions` when calling KBarProvider");const e=o.useMemo(()=>new T(t.actions),[]),[n,r]=o.useState({searchQuery:"",currentRootActionId:null,visualState:m.hidden,actions:{...e.actions},activeIndex:0}),i=o.useRef(n);i.current=n;const d=o.useCallback(()=>i.current,[]),c=o.useMemo(()=>new P(d),[d]);o.useEffect(()=>{i.current=n,c.notify()},[n,c]);const l=o.useRef({animations:{enterMs:200,exitMs:100},...t.options}),f=o.useCallback(u=>(r(s=>({...s,actions:e.add(u)})),function(){r(p=>({...p,actions:e.remove(u)}))}),[e]);return o.useMemo(()=>({getState:d,query:{setCurrentRootAction:u=>{r(s=>({...s,currentRootActionId:u}))},setVisualState:u=>{r(s=>({...s,visualState:typeof u=="function"?u(s.visualState):u}))},setSearch:u=>r(s=>({...s,searchQuery:u})),toggle:()=>{const u=[m.animatingOut,m.hidden].includes(n.visualState)?m.animatingIn:m.animatingOut;return r(s=>({...s,visualState:u})),u},registerActions:f,setActiveIndex:u=>r(s=>({...s,activeIndex:typeof u=="number"?u:u(s.activeIndex)}))},options:l.current,subscribe:(u,s)=>c.subscribe(u,s)}),[d,c,f])}class P{constructor(e){this.subscribers=[],this.getState=e}subscribe(e,n){const r=new B(()=>e(this.getState()),n);return this.subscribers.push(r),this.unsubscribe.bind(this,r)}unsubscribe(e){if(this.subscribers.length){const n=this.subscribers.indexOf(e);if(n>-1)return this.subscribers.splice(n,1)}}notify(){this.subscribers.forEach(e=>e.collect())}}class B{constructor(e,n){this.collector=e,this.onChange=n}collect(){try{const e=this.collector();D(e,this.collected)||(this.collected=e,this.onChange&&this.onChange(this.collected))}catch(e){console.warn(e)}}}function N(t,e){const n=o.useRef(e);n.current=e,o.useEffect(()=>{function r(i){t.current?.contains(i.target)||n.current()}return window.addEventListener("mousedown",r),()=>window.removeEventListener("mousedown",r)},[t])}function q(){const[t,e]=o.useState(!1);return o.useEffect(()=>{function n(){e(!0)}if(!t)return window.addEventListener("pointermove",n),()=>window.removeEventListener("pointermove",n)},[t]),t}function j(){return Math.random().toString(36).substring(2,9)}function V(t){return{id:j(),...t}}function $(){const t=document.createElement("div");t.style.visibility="hidden",t.style.overflow="scroll",document.body.appendChild(t);const e=document.createElement("div");t.appendChild(e);const n=t.offsetWidth-e.offsetWidth;return t.parentNode.removeChild(t),n}function Q(t,e=100){const[n,r]=o.useState(t),i=o.useRef(Date.now());return o.useEffect(()=>{const d=setTimeout(()=>{r(t),i.current=Date.now()},i.current-(Date.now()-e));return()=>{clearTimeout(d)}},[e,t]),n}function H(){return W(),z(),F(),U(),null}function W(){const{query:t,options:e,visualState:n,showing:r}=v(c=>({visualState:c.visualState,showing:c.visualState!==m.hidden}));o.useEffect(()=>{function c(l){(l.metaKey||l.ctrlKey)&&l.key==="k"&&l.defaultPrevented===!1&&(l.preventDefault(),t.toggle(),r?e.callbacks?.onClose?.():e.callbacks?.onOpen?.()),l.key==="Escape"&&(r&&(l.stopPropagation(),e.callbacks?.onClose?.()),t.setVisualState(f=>f===m.hidden||f===m.animatingOut?f:m.animatingOut))}return window.addEventListener("keydown",c,!0),()=>window.removeEventListener("keydown",c,!0)},[e.callbacks,t,r]);const i=o.useRef(),d=o.useCallback(c=>{let l=0;c===m.animatingIn&&(l=e.animations?.enterMs||0),c===m.animatingOut&&(l=e.animations?.exitMs||0),clearTimeout(i.current),i.current=setTimeout(()=>{let f=!1;t.setVisualState(()=>{const u=c===m.animatingIn?m.showing:m.hidden;return u===m.hidden&&(f=!0),u}),f&&t.setCurrentRootAction(null)},l)},[e.animations?.enterMs,e.animations?.exitMs,t]);o.useEffect(()=>{switch(n){case m.animatingIn:case m.animatingOut:d(n);break}},[d,n])}function z(){const{visualState:t,options:e}=v(n=>({visualState:n.visualState}));o.useEffect(()=>{if(t===m.animatingIn){if(document.body.style.pointerEvents="none",document.body.style.overflow="hidden",!e.disableScrollbarManagement){let n=$();const r=getComputedStyle(document.body)["margin-right"];r&&(n+=Number(r.replace(/\D/g,""))),document.body.style.marginRight=n+"px"}}else t===m.hidden&&(document.body.style.removeProperty("pointer-events"),document.body.style.removeProperty("overflow"),e.disableScrollbarManagement||document.body.style.removeProperty("margin-right"))},[e.disableScrollbarManagement,t])}function F(){const{actions:t,query:e}=v(n=>({actions:n.actions}));o.useEffect(()=>{const n=Object.keys(t).map(l=>t[l]),r=["input","select","button","textarea"];let i=[],d=Date.now();function c(l){const f=l.key?.toLowerCase(),u=document.activeElement;if(u&&(r.indexOf(u.tagName.toLowerCase())!==-1||u.attributes.getNamedItem("role")?.value==="textbox"||u.attributes.getNamedItem("contenteditable")?.value==="true")||l.metaKey||f==="shift")return;const p=Date.now();p-d>400&&(i=[]),i.push(f),d=p;const g=i.join("");for(let a of n)if(!!a.shortcut&&a.shortcut.join("")===g){l.preventDefault(),a.children?.length?(e.setCurrentRootAction(a.id),e.toggle()):a.perform?.(),i=[];break}}return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[t,e])}function U(){const{isShowing:t}=v(n=>({isShowing:n.visualState===m.showing||n.visualState===m.animatingIn})),e=o.useRef(null);o.useEffect(()=>{if(t){e.current=document.activeElement;return}const n=document.activeElement;n?.tagName.toLowerCase()==="input"&&n.blur();const r=e.current;r&&r.focus()},[t])}const x=o.createContext({}),_=t=>{const e=L(t);return o.createElement(x.Provider,{value:e},o.createElement(H,null),t.children)};function v(t){const{query:e,getState:n,subscribe:r,options:i}=o.useContext(x),d=o.useRef(t?.(n())),c=o.useRef(t),l=o.useCallback(s=>({...s,query:e,options:i}),[e,i]),[f,u]=o.useState(l(d.current));return o.useEffect(()=>{let s;return c.current&&(s=r(p=>c.current(p),p=>u(l(p)))),()=>{s&&s()}},[l,r]),f}function G(t){const{showing:e}=v(n=>({showing:n.visualState!==m.hidden}));return e?o.createElement(O,null,t.children):null}const J={position:"fixed",display:"flex",alignItems:"flex-start",justifyContent:"center",width:"100%",inset:"0px",padding:"14vh 16px 16px"};function X(t){return o.createElement("div",{style:J,...t},t.children)}const I="kbar-listbox",R=t=>`kbar-listbox-item-${t}`;function Y(t){const{query:e,search:n,actions:r,currentRootActionId:i,activeIndex:d,showing:c,options:l}=v(s=>({search:s.searchQuery,currentRootActionId:s.currentRootActionId,actions:s.actions,activeIndex:s.activeIndex,showing:s.visualState===m.showing})),f=o.useRef(null);o.useEffect(()=>(e.setSearch(""),f.current.focus(),()=>e.setSearch("")),[i,e]);const u=o.useMemo(()=>i?r[i].name:"Type a command or search\u2026",[r,i]);return o.createElement("input",{ref:f,autoFocus:!0,autoComplete:"off",role:"combobox",spellCheck:"false","aria-expanded":c,"aria-controls":I,"aria-activedescendant":R(d),value:n,placeholder:u,onChange:s=>{t.onChange?.(s),e.setSearch(s.target.value),l?.callbacks?.onQueryChange?.(s.target.value)},onKeyDown:s=>{if(i&&!n&&s.key==="Backspace"){const p=r[i].parent;e.setCurrentRootAction(p?.id)}},...t})}const w=0,Z=t=>{const e=o.useRef(null),n=o.useRef(null),r=o.useRef(t.items);r.current=t.items;const i=K({size:r.current.length,parentRef:n}),{query:d,search:c,currentRootActionId:l,activeIndex:f,options:u}=v(a=>({search:a.searchQuery,currentRootActionId:a.currentRootActionId,activeIndex:a.activeIndex}));o.useEffect(()=>{const a=h=>{h.key==="ArrowUp"||h.ctrlKey&&h.key==="p"?(h.preventDefault(),d.setActiveIndex(b=>{let y=b>w?b-1:b;if(typeof r.current[y]=="string"){if(y===0)return b;y-=1}return y})):h.key==="ArrowDown"||h.ctrlKey&&h.key==="n"?(h.preventDefault(),d.setActiveIndex(b=>{let y=b<r.current.length-1?b+1:b;if(typeof r.current[y]=="string"){if(y===r.current.length-1)return b;y+=1}return y})):h.key==="Enter"&&(h.preventDefault(),e.current?.click())};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[d]);const{scrollToIndex:s}=i;o.useEffect(()=>{s(f,{align:f<=1?"end":"auto"})},[f,s]),o.useEffect(()=>{d.setActiveIndex(typeof t.items[w]=="string"?w+1:w)},[c,l,t.items,d]);const p=o.useCallback(a=>{typeof a!="string"&&(a.perform?(a.perform(),d.toggle()):(d.setSearch(""),d.setCurrentRootAction(a.id)),u.callbacks?.onSelectAction?.(a))},[d,u]),g=q();return o.createElement("div",{ref:n,style:{maxHeight:t.maxHeight||400,overflow:"auto"}},o.createElement("div",{role:"listbox",id:I,style:{height:`${i.totalSize}px`,width:"100%",position:"relative"}},i.virtualItems.map(a=>{const h=r.current[a.index],b=typeof h!="string"&&{onPointerMove:()=>g&&f!==a.index&&d.setActiveIndex(a.index),onPointerDown:()=>d.setActiveIndex(a.index),onClick:()=>p(h)},y=a.index===f;return o.createElement("div",{ref:y?e:null,id:R(a.index),role:"option","aria-selected":y,key:a.index,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${a.start}px)`},...b},o.cloneElement(t.onRender({item:h,active:y}),{ref:a.measureRef}))})))};function ee(t,e=[]){const{query:n}=v(),r=o.useMemo(()=>t,e);o.useEffect(()=>{if(!r.length)return;const i=n.registerActions(r);return()=>{i()}},[n,r])}const te="none";function ne(){const{actions:t,search:e,rootActionId:n}=v(c=>({actions:c.actions,search:c.searchQuery,rootActionId:c.currentRootActionId})),r=o.useMemo(()=>Object.keys(t).reduce((c,l)=>{const f=t[l];return!f.parent&&!n&&(c[l]=f),f.parent?.id===n&&(c[l]=f),c},{}),[t,n]),i=re(r,e);return o.useMemo(()=>{const c=i.reduce((f,u)=>{const s=u.section||te;return f[s]||(f[s]=[]),f[s].push(u),f},{});let l=[];return Object.keys(c).forEach(f=>{const u=c[f];l.push({name:f,actions:u})}),l},[i])}function re(t,e){const n=oe(e,100),r=o.useMemo(()=>Object.keys(t).map(i=>t[i]),[t]);return o.useMemo(()=>e.trim()===""?r:k(r,n,{keys:["name","keywords","subtitle"]}),[n,r])}function oe(t,e){const[n,r]=o.useState(t),i=o.useRef(Date.now());return o.useEffect(()=>{const d=setTimeout(()=>{r(t),i.current=Date.now()},i.current-(Date.now()-e));return()=>clearTimeout(d)},[e,t]),n}const A="none";function se(){const{search:t,actions:e,rootActionId:n}=v(s=>({search:s.searchQuery,actions:s.actions,rootActionId:s.currentRootActionId})),r=o.useMemo(()=>Object.keys(e).reduce((s,p)=>{const g=e[p];return!g.parent&&!n&&s.push(g),g.parent&&g.parent.id===n&&s.push(g),s},[]),[e,n]),i=o.useCallback(s=>function p(g,a=[...g]){for(let h=0;h<g.length;h++)g[h].children.length>0&&(a.push(...g[h].children),p(g[h].children,a));return a}(s),[]),d=!t,c=o.useMemo(()=>d?r:i(r),[i,r,d]),l=ie(c,t),f=o.useMemo(()=>{let s={};for(let g=0;g<l.length;g++){const a=l[g],h=a.section||A;s[h]||(s[h]=[]),s[h].push(a)}let p=[];return Object.keys(s).forEach(g=>{g!==A&&p.push(g);const a=s[g];for(let h=0;h<a.length;h++)p.push(a[h])}),p},[l]),u=o.useMemo(()=>n,[f]);return o.useMemo(()=>({results:f,rootActionId:u}),[u,f])}function ie(t,e){const n=o.useMemo(()=>({filtered:t,search:e}),[t,e]),{filtered:r,search:i}=Q(n);return o.useMemo(()=>i.trim()===""?r:k(r,i,{keys:["name","keywords","subtitle"]}),[r,i])}const C=[{opacity:0,transform:"scale(.99)"},{opacity:1,transform:"scale(1.01)"},{opacity:1,transform:"scale(1)"}],ce=[{transform:"scale(1)"},{transform:"scale(.98)"},{transform:"scale(1)"}],ue=({children:t,style:e,className:n})=>{const{visualState:r,currentRootActionId:i,query:d,options:c}=v(a=>({visualState:a.visualState,currentRootActionId:a.currentRootActionId})),l=o.useRef(null),f=o.useRef(null),u=c?.animations?.enterMs||0,s=c?.animations?.exitMs||0;o.useEffect(()=>{if(r===m.showing)return;const a=r===m.animatingIn?u:s;l.current?.animate(C,{duration:a,easing:r===m.animatingOut?"ease-in":"ease-out",direction:r===m.animatingOut?"reverse":"normal",fill:"forwards"})},[c,r,u,s]);const p=o.useRef();o.useEffect(()=>{if(r===m.showing){const a=l.current,h=f.current;if(!a||!h)return;const b=new ResizeObserver(y=>{for(let M of y){const S=M.contentRect;p.current||(p.current=S.height),a.animate([{height:`${p.current}px`},{height:`${S.height}px`}],{duration:u/2,easing:"ease-out",fill:"forwards"}),p.current=S.height}});return b.observe(h),()=>{b.unobserve(h)}}},[r,c,u,s]);const g=o.useRef(!0);return o.useEffect(()=>{if(g.current){g.current=!1;return}const a=l.current;a&&a.animate(ce,{duration:u,easing:"ease-out"})},[i,u]),N(l,()=>{d.setVisualState(m.animatingOut),c.callbacks?.onClose?.()}),o.createElement("div",{ref:l,style:{...C[0],...e,pointerEvents:"auto"},className:n},o.createElement("div",{ref:f},t))};export{I as KBAR_LISTBOX,ue as KBarAnimator,x as KBarContext,G as KBarPortal,X as KBarPositioner,_ as KBarProvider,Z as KBarResults,Y as KBarSearch,m as VisualState,V as createAction,R as getListboxItemId,se as useDeepMatches,v as useKBar,ne as useMatches,ee as useRegisterActions};
